<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IPTV Panel - Local Website</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#0f62fe;
      --success:#059669; --danger:#ef4444; --glass: rgba(15,98,254,0.06);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:var(--bg);color:#0f172a}
    .wrap{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 1px 2px rgba(2,6,23,0.06);margin-bottom:14px}
    .grid{display:grid;gap:12px}
    .cols-3{grid-template-columns:320px 1fr 360px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="text"],input[type="password"],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;background:white}
    textarea{min-height:120px;resize:vertical}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--accent);color:white}
    .btn-ghost{background:transparent;border:1px solid #e6e9ef}
    .btn-danger{background:var(--danger);color:white}
    .muted{color:var(--muted);font-size:13px}
    .flex{display:flex;gap:8px;align-items:center}
    .users-list{max-height:260px;overflow:auto}
    .user-item{padding:8px;border-radius:8px;border:1px solid #f1f3f7;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .channels-list{max-height:420px;overflow:auto;border-radius:8px;border:1px solid #f1f3f7}
    .channel-row{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid #f6f8fb}
    .channel-row:last-child{border-bottom:0}
    .search{display:flex;gap:8px;margin-bottom:8px}
    .small{font-size:13px;color:var(--muted)}
    .topbar{display:flex;gap:8px;align-items:center}
    .center{display:flex;flex-direction:column;gap:12px}
    .right-panel{display:flex;flex-direction:column;gap:12px}
    .login-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.45)}
    .login-box{width:360px;padding:18px;border-radius:12px;background:white}
    .footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    .badge{background:var(--glass);padding:6px 8px;border-radius:999px;font-size:12px}
    input[type="file"]{display:none}
    .row{display:flex;gap:8px;align-items:center}
    .flex-col{display:flex;flex-direction:column;gap:8px}
    a.link{color:var(--accent);text-decoration:none}
    .top-actions{display:flex;gap:8px;align-items:center}
    @media(max-width:980px){ .cols-3{grid-template-columns:1fr} .wrap{padding:12px} .login-box{width:95%} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>IPTV Panel — Local Website</h1>
        <div class="small">Manage users, import M3U, assign channels, and generate per-user playlists</div>
      </div>
      <div class="topbar">
        <div class="badge" id="channelsCount">Channels: 0</div>
        <div class="badge" id="usersCount">Users: 0</div>
        <button class="btn btn-ghost" id="btnBackup">Backup</button>
        <button class="btn btn-ghost" id="btnRestore">Restore</button>
        <button class="btn btn-ghost" id="btnLogout">Logout</button>
      </div>
    </header>

    <div class="grid cols-3">
      <!-- left: users & import -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Users</strong>
          <div class="small">Admin controls</div>
        </div>
        <div style="margin-top:10px" class="flex-col">
          <div>
            <label>New user</label>
            <div class="row">
              <input id="inpUsername" placeholder="username (e.g. user1)" type="text" />
              <input id="inpPassword" placeholder="password" type="password" style="width:130px" />
            </div>
            <div style="margin-top:8px" class="row">
              <button class="btn btn-primary" id="btnAddUser">Add</button>
              <button class="btn btn-ghost" id="btnClearUser">Clear</button>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Users list</label>
            <div class="users-list" id="usersList"></div>
          </div>
        </div>

        <hr style="margin:12px 0;border:0;height:1px;background:#f1f3f7" />

        <div>
          <label>Import M3U (paste)</label>
          <textarea id="m3uPaste" placeholder="#EXTM3U\n#EXTINF:-1,Channel name\nhttp://..."></textarea>
          <div style="margin-top:8px" class="row">
            <button class="btn btn-primary" id="btnImport">Import Pasted</button>
            <label class="btn btn-ghost" style="cursor:pointer">
              Choose File
              <input type="file" id="m3uFile" accept=".m3u,.txt" />
            </label>
            <button class="btn btn-ghost" id="btnClearChannels">Clear Channels</button>
          </div>
        </div>
      </div>

      <!-- center: channels -->
      <div class="card center">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Channels</strong>
          <div class="small">Search & assign</div>
        </div>

        <div class="search" style="margin-top:8px">
          <input id="search" placeholder="Search channels or groups..." type="text" />
          <select id="filterGroup" style="width:160px">
            <option value="">All groups</option>
          </select>
          <div style="margin-left:auto" class="small">Select a user to assign channels</div>
        </div>

        <div class="channels-list" id="channelsList"></div>
      </div>

      <!-- right: selected user preview & add channel -->
      <div class="card right-panel">
        <div>
          <strong>Selected user</strong>
          <div class="small" id="selectedPreview">No user selected</div>
        </div>

        <div>
          <label>Selected actions</label>
          <div class="row">
            <button class="btn btn-primary" id="btnDownloadUser">Download M3U</button>
            <button class="btn btn-ghost" id="btnToggleAll">Toggle All Visible</button>
            <button class="btn btn-danger" id="btnDeleteUser">Delete User</button>
          </div>
        </div>

        <hr />

        <div>
          <label>Add single channel</label>
          <input id="chTitle" placeholder="Channel title" type="text" />
          <input id="chUrl" placeholder="Stream URL (http... or udp://)" type="text" style="margin-top:8px" />
          <input id="chGroup" placeholder="Group (optional)" type="text" style="margin-top:8px" />
          <div style="margin-top:8px" class="row">
            <button class="btn btn-primary" id="btnAddChannel">Add Channel</button>
            <button class="btn btn-ghost" id="btnClearAdd">Clear</button>
          </div>
        </div>

        <div style="margin-top:auto">
          <label>Settings</label>
          <div class="small">Change admin password (demo only, stored in localStorage)</div>
          <input id="adminPass" placeholder="New admin pass" type="password" style="margin-top:8px" />
          <div style="margin-top:8px" class="row">
            <button class="btn btn-primary" id="btnSetAdmin">Set Password</button>
            <button class="btn btn-ghost" id="btnResetData">Reset Data</button>
          </div>
        </div>
      </div>
    </div>

    <div class="footer card">
      <div>Local demo panel. For production: implement backend, hashed passwords, and tokenized stream URLs.</div>
      <div style="margin-top:6px" class="small">Created for quick local use.</div>
    </div>
  </div>

  <!-- Login overlay -->
  <div id="loginOverlay" class="login-overlay" style="display:none">
    <div class="login-box card">
      <h3 style="margin-top:0">Admin Login</h3>
      <div class="small">Enter admin password to open the panel</div>
      <div style="margin-top:12px">
        <input id="loginPass" placeholder="admin password" type="password" />
      </div>
      <div style="margin-top:12px" class="row">
        <button class="btn btn-primary" id="btnLogin">Login</button>
        <button class="btn btn-ghost" id="btnDemo">Open Demo (no lock)</button>
      </div>
      <div style="margin-top:12px" class="small">Default admin password: <strong>admin123</strong></div>
    </div>
  </div>

<script>
/* ===========================
   Simple IPTV Panel (client)
   Stored in localStorage:
     - iptv_users: [{id,username,password,active,allowedChannels:[] ,createdAt}]
     - iptv_channels: [{id,title,url,group,tvgId}]
     - iptv_admin_pass: '...'
   =========================== */

(function(){
  // Utilities
  const $ = id => document.getElementById(id);
  const randId = () => Math.random().toString(36).slice(2,9);

  // State
  let users = JSON.parse(localStorage.getItem('iptv_users') || '[]');
  let channels = JSON.parse(localStorage.getItem('iptv_channels') || '[]');
  let adminPass = localStorage.getItem('iptv_admin_pass') || 'admin123';
  let selectedUserId = null;
  let lastSearch = '';

  // Elements
  const usersList = $('usersList');
  const channelsList = $('channelsList');
  const channelsCount = $('channelsCount');
  const usersCount = $('usersCount');
  const m3uPaste = $('m3uPaste');
  const m3uFile = $('m3uFile');
  const searchInput = $('search');
  const filterGroup = $('filterGroup');
  const selectedPreview = $('selectedPreview');

  // Save helpers
  function saveAll(){
    localStorage.setItem('iptv_users', JSON.stringify(users));
    localStorage.setItem('iptv_channels', JSON.stringify(channels));
    localStorage.setItem('iptv_admin_pass', adminPass);
    renderCounts();
  }

  function renderCounts(){
    channelsCount.textContent = 'Channels: ' + channels.length;
    usersCount.textContent = 'Users: ' + users.length;
  }

  // Login logic
  const loginOverlay = $('loginOverlay');
  function showLogin(){ loginOverlay.style.display='flex'; }
  function hideLogin(){ loginOverlay.style.display='none'; }

  // Init login on first load
  function ensureAdminPass(){
    if(!localStorage.getItem('iptv_admin_pass')) {
      adminPass = 'admin123';
      localStorage.setItem('iptv_admin_pass', adminPass);
    } else {
      adminPass = localStorage.getItem('iptv_admin_pass');
    }
  }
  ensureAdminPass();
  // Show login if not 'demo opened'
  if(!localStorage.getItem('iptv_demo_open')){
    showLogin();
  } else {
    hideLogin();
  }

  // UI Render functions
  function renderUsers(){
    usersList.innerHTML='';
    if(users.length===0){ usersList.innerHTML='<div class="small muted">No users yet</div>'; return; }
    users.forEach(u => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <div style="min-width:0">
          <div style="font-weight:600">${escapeHtml(u.username)}</div>
          <div class="small">${u.active ? 'Active' : 'Disabled'} • ${new Date(u.createdAt).toLocaleString()}</div>
          <div class="small">Allowed: ${ (u.allowedChannels||[]).length }</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-select" data-id="${u.id}">${selectedUserId===u.id ? 'Selected' : 'Select'}</button>
            <button class="btn btn-ghost btn-download" data-id="${u.id}">Download</button>
            <button class="btn btn-danger btn-delete" data-id="${u.id}">Delete</button>
          </div>
          <div class="small">pwd: ${escapeHtml(u.password || '')}</div>
        </div>
      `;
      usersList.appendChild(div);
    });
    // attach events
    usersList.querySelectorAll('.btn-select').forEach(b => b.onclick = (e) => {
      const id = e.currentTarget.dataset.id;
      selectedUserId = (selectedUserId === id) ? null : id;
      renderUsers(); renderChannels();
      renderSelectedPreview();
    });
    usersList.querySelectorAll('.btn-download').forEach(b => b.onclick = (e) => {
      const id = e.currentTarget.dataset.id;
      downloadUserM3U(id);
    });
    usersList.querySelectorAll('.btn-delete').forEach(b => b.onclick = (e) => {
      const id = e.currentTarget.dataset.id;
      if(!confirm('Delete user?')) return;
      users = users.filter(x => x.id !== id);
      if(selectedUserId === id) selectedUserId = null;
      saveAll(); renderUsers(); renderChannels(); renderSelectedPreview();
    });
  }

  function renderChannels(){
    // build group list
    const groups = Array.from(new Set(channels.map(c => c.group || '').filter(Boolean))).sort();
    filterGroup.innerHTML = '<option value="">All groups</option>' + groups.map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join('');
    const q = searchInput.value.trim().toLowerCase();
    lastSearch = q;
    channelsList.innerHTML = '';
    const visible = channels.filter(c=>{
      if(filterGroup.value && (c.group||'').toLowerCase() !== filterGroup.value.toLowerCase()) return false;
      if(!q) return true;
      return (c.title||'').toLowerCase().includes(q) || (c.group||'').toLowerCase().includes(q) || (c.url||'').toLowerCase().includes(q);
    });
    if(visible.length===0){ channelsList.innerHTML = '<div style="padding:16px" class="small muted">No channels</div>'; return; }
    visible.forEach((c,i)=>{
      const row = document.createElement('div');
      row.className = 'channel-row';
      const allowed = selectedUserId ? (users.find(u=>u.id===selectedUserId)?.allowedChannels||[]).includes(c.id) : false;
      row.innerHTML = `
        <div style="width:32px;font-size:13px;color:var(--muted)">${i+1}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600">${escapeHtml(c.title)}</div>
          <div class="small" style="margin-top:4px">${escapeHtml(c.group || '')} • ${escapeHtml(c.tvgId || '')}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-ghost btn-copy" data-id="${c.id}">Copy URL</button>
          <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="chk-allow" data-id="${c.id}" ${allowed ? 'checked' : ''}/> Allowed</label>
        </div>
      `;
      channelsList.appendChild(row);
    });

    // attach events
    channelsList.querySelectorAll('.btn-copy').forEach(b=> b.onclick = (e) => {
      const id = e.currentTarget.dataset.id;
      const ch = channels.find(x=>x.id===id);
      if(!ch) return alert('Not found');
      navigator.clipboard.writeText(ch.url).then(()=> alert('URL copied'));
    });
    channelsList.querySelectorAll('.chk-allow').forEach(chk => chk.onchange = (e) => {
      const id = e.target.dataset.id;
      if(!selectedUserId) { e.target.checked = false; return alert('Select a user first'); }
      const user = users.find(u=>u.id===selectedUserId);
      if(!user) return;
      user.allowedChannels = user.allowedChannels || [];
      if(e.target.checked){
        if(!user.allowedChannels.includes(id)) user.allowedChannels.push(id);
      } else {
        user.allowedChannels = user.allowedChannels.filter(x=>x!==id);
      }
      saveAll(); renderUsers(); renderSelectedPreview();
    });
  }

  function renderSelectedPreview(){
    if(!selectedUserId){ selectedPreview.textContent = 'No user selected'; return; }
    const u = users.find(x=>x.id===selectedUserId);
    if(!u){ selectedPreview.textContent = 'User not found'; return; }
    selectedPreview.innerHTML = `
      <div style="font-weight:600">${escapeHtml(u.username)}</div>
      <div class="small">Status: ${u.active ? 'Active' : 'Disabled'}</div>
      <div class="small">Allowed channels: ${(u.allowedChannels||[]).length}</div>
    `;
  }

  // Parse M3U basic
  function parseM3U(text){
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const out = [];
    let lastMeta = null;
    for(const line of lines){
      if(line.startsWith('#EXTINF')){ lastMeta = line; continue; }
      if(line.startsWith('#')){ continue; }
      // assume URL line
      const url = line;
      let title = url;
      let group = '';
      let tvgId = '';
      if(lastMeta){
        const comma = lastMeta.indexOf(',');
        if(comma !== -1) title = lastMeta.slice(comma+1).trim();
        const gm = lastMeta.match(/group-title\s*=\s*"([^"]+)"/i);
        const tv = lastMeta.match(/tvg-id\s*=\s*"([^"]+)"/i);
        if(gm) group = gm[1];
        if(tv) tvgId = tv[1];
      }
      out.push({ id: randId(), title: title || url, url, group, tvgId});
      lastMeta = null;
    }
    return out;
  }

  // Import functions
  $('btnImport').onclick = () => {
    const text = m3uPaste.value.trim();
    if(!text) return alert('Paste M3U text first');
    const parsed = parseM3U(text);
    mergeChannels(parsed);
    m3uPaste.value = '';
    alert('Imported ' + parsed.length + ' channels (duplicates skipped by URL)');
  };
  m3uFile.onchange = (e) => {
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = function(ev){
      const text = ev.target.result;
      const parsed = parseM3U(text);
      mergeChannels(parsed);
      alert('Imported ' + parsed.length + ' channels from file (duplicates skipped by URL)');
    };
    r.readAsText(f);
    e.target.value = '';
  };

  function mergeChannels(parsed){
    const existingUrls = new Set(channels.map(c=>c.url));
    const toAdd = parsed.filter(p => !existingUrls.has(p.url));
    channels = [...toAdd, ...channels];
    saveAll(); renderChannels(); renderCounts();
  }

  // Add single channel
  $('btnAddChannel').onclick = () => {
    const title = $('chTitle').value.trim();
    const url = $('chUrl').value.trim();
    const group = $('chGroup').value.trim();
    if(!title || !url) return alert('Title and URL required');
    channels.unshift({ id: randId(), title, url, group, tvgId: '' });
    $('chTitle').value=''; $('chUrl').value=''; $('chGroup').value='';
    saveAll(); renderChannels(); renderCounts();
  };

  // Users
  $('btnAddUser').onclick = () => {
    const username = $('inpUsername').value.trim();
    const password = $('inpPassword').value.trim();
    if(!username || !password) return alert('username and password required');
    if(users.some(u => u.username === username)) return alert('User exists');
    const u = { id: randId(), username, password, active:true, allowedChannels: channels.map(c=>c.id), createdAt: Date.now() };
    users.unshift(u);
    $('inpUsername').value=''; $('inpPassword').value='';
    saveAll(); renderUsers(); renderSelectedPreview();
  };
  $('btnClearUser').onclick = () => { $('inpUsername').value=''; $('inpPassword').value=''; };

  // Download user M3U
  function generateUserM3UText(userId){
    const user = users.find(u => u.id === userId);
    if(!user) return '';
    const allowed = new Set(user.allowedChannels || []);
    const lines = ['#EXTM3U'];
    for(const ch of channels){
      if(allowed.has(ch.id)){
        const metaParts = [];
        if(ch.tvgId) metaParts.push(`tvg-id="${ch.tvgId}"`);
        if(ch.group) metaParts.push(`group-title="${ch.group}"`);
        const meta = `#EXTINF:-1 ${metaParts.join(' ')} ,${ch.title}`;
        lines.push(meta); lines.push(ch.url);
      }
    }
    return lines.join('\n');
  }
  function downloadUserM3U(userId){
    const text = generateUserM3UText(userId);
    if(!text) return alert('No playlist for this user');
    const blob = new Blob([text], { type: 'application/x-mpegURL' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const user = users.find(u=>u.id===userId);
    a.download = (user ? user.username : 'user') + '-playlist.m3u';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  $('btnDownloadUser').onclick = () => {
    if(!selectedUserId) return alert('Select a user first');
    downloadUserM3U(selectedUserId);
  };

  // Toggle all visible channels allowed/unallowed for selected user
  $('btnToggleAll').onclick = () => {
    if(!selectedUserId) return alert('Select a user first');
    const visible = channels.filter(c=>{
      if(filterGroup.value && (c.group||'').toLowerCase() !== filterGroup.value.toLowerCase()) return false;
      if(!lastSearch) return true;
      return (c.title||'').toLowerCase().includes(lastSearch) || (c.group||'').toLowerCase().includes(lastSearch);
    });
    const user = users.find(u=>u.id===selectedUserId);
    if(!user) return;
    user.allowedChannels = user.allowedChannels || [];
    // if any visible channel is not allowed, we'll set them all allowed; otherwise remove them
    const anyNotAllowed = visible.some(c => !user.allowedChannels.includes(c.id));
    if(anyNotAllowed){
      // add all visible
      visible.forEach(c => { if(!user.allowedChannels.includes(c.id)) user.allowedChannels.push(c.id); });
    } else {
      // remove all visible
      user.allowedChannels = user.allowedChannels.filter(id => !visible.some(c => c.id === id));
    }
    saveAll(); renderChannels(); renderUsers(); renderSelectedPreview();
  };

  // Delete selected user
  $('btnDeleteUser').onclick = () => {
    if(!selectedUserId) return alert('Select a user first');
    if(!confirm('Delete selected user?')) return;
    users = users.filter(u=>u.id!==selectedUserId);
    selectedUserId = null;
    saveAll(); renderUsers(); renderChannels(); renderSelectedPreview();
  };

  // Backup / Restore
  $('btnBackup').onclick = () => {
    const data = { users, channels };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'iptv-backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };
  $('btnRestore').onclick = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';
    input.onchange = (e) => {
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (ev) => {
        try{
          const data = JSON.parse(ev.target.result);
          if(Array.isArray(data.users) && Array.isArray(data.channels)){
            users = data.users; channels = data.channels;
            saveAll(); renderUsers(); renderChannels(); renderSelectedPreview();
            alert('Restore complete');
          } else alert('Invalid backup file');
        } catch(err){ alert('Failed to parse file'); }
      };
      r.readAsText(f);
    };
    input.click();
  };

  // Search & filter
  searchInput.oninput = () => { renderChannels(); };
  filterGroup.onchange = () => { renderChannels(); };

  // Clear channels
  $('btnClearChannels').onclick = () => {
    if(!confirm('Clear all channels?')) return;
    channels = []; saveAll(); renderChannels();
  };

  // Admin settings
  $('btnSetAdmin').onclick = () => {
    const p = $('adminPass').value.trim();
    if(!p) return alert('Enter new admin password');
    adminPass = p;
    localStorage.setItem('iptv_admin_pass', adminPass);
    $('adminPass').value='';
    alert('Admin password changed');
  };
  $('btnResetData').onclick = () => {
    if(!confirm('Reset ALL data (users, channels, admin pass)?')) return;
    users = []; channels = []; adminPass = 'admin123';
    localStorage.removeItem('iptv_users'); localStorage.removeItem('iptv_channels'); localStorage.setItem('iptv_admin_pass', adminPass);
    renderUsers(); renderChannels(); renderSelectedPreview(); renderCounts();
    alert('Data reset to empty. Default admin password is admin123');
  };

  // Login handlers
  $('btnLogin').onclick = () => {
    const p = $('loginPass').value;
    if(p === adminPass){
      localStorage.setItem('iptv_demo_open', '1');
      hideLogin();
      $('loginPass').value='';
      renderUsers(); renderChannels();
    } else alert('Wrong password');
  };
  $('btnDemo').onclick = () => {
    // open demo mode without password
    localStorage.setItem('iptv_demo_open', '1');
    hideLogin();
    renderUsers(); renderChannels();
  };

  // Logout
  $('btnLogout').onclick = () => {
    localStorage.removeItem('iptv_demo_open');
    showLogin();
  };

  // Reset add form
  $('btnClearAdd').onclick = () => { $('chTitle').value=''; $('chUrl').value=''; $('chGroup').value=''; };

  // Simple HTML escape
  function escapeHtml(s){
    if(!s && s!==0) return '';
    return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Misc: copy initial demo data if none exist (optional)
  function ensureDemoData(){
    if(localStorage.getItem('iptv_seeded')) return;
    if(channels.length===0 && users.length===0){
      // small sample
      channels = [
        { id: randId(), title:'Demo News', url:'http://example.com/stream1', group:'News', tvgId:'' },
        { id: randId(), title:'Demo Movie', url:'http://example.com/stream2', group:'Movies', tvgId:'' },
        { id: randId(), title:'Demo Sports', url:'http://example.com/stream3', group:'Sports', tvgId:'' },
      ];
      users = [
        { id: randId(), username:'user1', password:'pass1', active:true, allowedChannels: channels.map(c=>c.id), createdAt: Date.now() }
      ];
      localStorage.setItem('iptv_seeded','1');
      saveAll();
    }
  }

  // Simple utils for file drop? omitted to keep compact

  // Attach misc UI buttons
  $('btnResetData').title = 'Delete all stored data and reset to defaults';

  // initial render
  ensureDemoData();
  renderCounts();
  renderUsers();
  renderChannels();
  renderSelectedPreview();

  // download per-user from user list buttons (event binding already applied during renderUsers)
  // Also allow downloading by clicking user download in list - already implemented

  // Make sure resize behavior ok for small screens (nothing else)
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Administration Panel</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* Style for disabled buttons */
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow rounded-lg p-4 mb-6">
            <h1 class="text-3xl font-extrabold text-blue-700">IPTV Admin Dashboard</h1>
            <p class="text-gray-500 mt-1" id="auth-status">Initializing...</p>
        </header>

        <!-- Tab Navigation -->
        <div class="flex space-x-1 p-1 bg-white rounded-lg shadow mb-6">
            <button onclick="showTab('dashboard')" class="tab-button w-1/3 py-2 px-4 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-150" data-tab="dashboard">Dashboard</button>
            <button onclick="showTab('users')" class="tab-button w-1/3 py-2 px-4 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-150" data-tab="users">User Management</button>
            <button onclick="showTab('sources')" class="tab-button w-1/3 py-2 px-4 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-150" data-tab="sources">M3U Sources</button>
        </div>

        <!-- --- Tab Content Sections --- -->

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <!-- Card 1: Total Users -->
                <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-500">Total Users</p>
                    <p id="stat-total-users" class="mt-1 text-3xl font-bold text-gray-900">0</p>
                </div>
                <!-- Card 2: Active Users -->
                <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-green-500">
                    <p class="text-sm font-medium text-gray-500">Active Subscriptions</p>
                    <p id="stat-active-users" class="mt-1 text-3xl font-bold text-gray-900">0</p>
                </div>
                <!-- Card 3: Total Sources -->
                <div class="bg-white p-5 rounded-lg shadow-md border-b-4 border-indigo-500">
                    <p class="text-sm font-medium text-gray-500">M3U Sources</p>
                    <p id="stat-total-sources" class="mt-1 text-3xl font-bold text-gray-900">0</p>
                </div>
            </div>

            <!-- Recent Activity/Summary -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Dashboard Summary</h2>
                <div id="dashboard-summary" class="text-gray-600 space-y-3">
                    <p>Welcome to your IPTV management panel. Use the tabs above to manage M3U playlist sources and user access.</p>
                    <p class="text-sm text-gray-500">All data is securely stored and managed in real-time using Google Firestore.</p>
                </div>
            </div>
        </div>

        <!-- User Management Tab -->
        <div id="users-tab" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">User Subscriptions</h2>
                <button id="add-user-btn" onclick="openUserModal()" class="flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-150 btn-disabled" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    Add New User
                </button>
            </div>
            
            <div class="bg-white shadow rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expires</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">M3U Link</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-list" class="bg-white divide-y divide-gray-200">
                        <!-- User rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- M3U Sources Tab -->
        <div id="sources-tab" class="tab-content hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">M3U Playlist Sources</h2>
                <button id="add-source-btn" onclick="openSourceModal()" class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-150 btn-disabled" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Add New Source
                </button>
            </div>

            <div class="bg-white shadow rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base M3U URL</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Count</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sources-list" class="bg-white divide-y divide-gray-200">
                        <!-- Source rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- --- Modals --- -->

        <!-- M3U Source Modal -->
        <div id="source-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Add/Edit M3U Source</h3>
                <form id="source-form">
                    <input type="hidden" id="source-id">
                    <div class="mb-4">
                        <label for="source-name" class="block text-sm font-medium text-gray-700">Source Name</label>
                        <input type="text" id="source-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-6">
                        <label for="source-url" class="block text-sm font-medium text-gray-700">M3U URL (Full Playlist Link)</label>
                        <!-- type="text" allows submission without strict browser URL validation -->
                        <input type="text" id="source-url" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        <p class="mt-1 text-xs text-gray-500">Must include http:// or https://</p>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeSourceModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-150">Cancel</button>
                        <button type="submit" id="save-source-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-150">Save Source</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- User Modal -->
        <div id="user-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Add/Edit User</h3>
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="user-username" class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="user-username" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="user-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="text" id="user-password" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="user-source" class="block text-sm font-medium text-gray-700">Assign M3U Source</label>
                        <select id="user-source" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="user-expiry" class="block text-sm font-medium text-gray-700">Expiration Date</label>
                        <input type="date" id="user-expiry" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex justify-end space-space-x-3">
                        <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-150">Cancel</button>
                        <button type="submit" id="save-user-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-150">Save User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Generic Message Modal (Used for copying and errors) -->
        <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 m-4">
                <h3 id="message-modal-title" class="text-xl font-bold text-gray-900 mb-4">Link Generated!</h3>
                <p id="message-modal-content" class="text-gray-700 mb-4 break-words">Your personalized M3U link has been created.</p>
                <div id="message-modal-link-box" class="bg-gray-100 p-3 rounded-lg border border-gray-200 mb-6 hidden">
                    <p class="text-sm font-mono break-all" id="message-modal-link-text"></p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="message-modal-copy-btn" onclick="copyModalLink()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-150 hidden">Copy Link</button>
                    <button type="button" onclick="closeMessageModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors duration-150">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50 hidden">
            <div class="flex items-center space-x-2 text-blue-600">
                <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Loading Data...</span>
            </div>
        </div>

    </div>

    <script type="module">
        // --- Firebase Configuration & Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment. DO NOT change the variable names.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        setLogLevel('Debug');
        
        // --- Utility Functions ---

        /**
         * Shows a loading spinner across the screen.
         * @param {boolean} show - True to show, false to hide.
         */
        const showLoading = (show) => {
            document.getElementById('loading-overlay').classList.toggle('hidden', !show);
        };

        /**
         * Shows a custom modal message.
         * @param {string} title - The title of the modal.
         * @param {string} content - The main message content.
         * @param {string} [linkText=null] - Optional M3U link to display and copy.
         */
        window.showMessage = (title, content, linkText = null) => {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-content').textContent = content;
            const linkBox = document.getElementById('message-modal-link-box');
            const copyBtn = document.getElementById('message-modal-copy-btn');
            
            if (linkText) {
                document.getElementById('message-modal-link-text').textContent = linkText;
                linkBox.classList.remove('hidden');
                copyBtn.classList.remove('hidden');
            } else {
                linkBox.classList.add('hidden');
                copyBtn.classList.add('hidden');
            }

            document.getElementById('message-modal').classList.remove('hidden');
        };

        window.closeMessageModal = () => {
            document.getElementById('message-modal').classList.add('hidden');
        };

        window.copyModalLink = () => {
            const link = document.getElementById('message-modal-link-text').textContent;
            window.copyToClipboard(link);
        };

        window.copyToClipboard = (text) => {
            try {
                // Use execCommand('copy') as navigator.clipboard may not work in iframes
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                // Update the modal's copy button to show success
                const copyButton = document.getElementById('message-modal-copy-btn');
                if (copyButton) {
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                console.error('Failed to copy text: ', err);
                // Fallback message
                showMessage('Copy Failed', 'Please manually copy the link from the box below.', null);
            }
        };

        /**
         * Toggles the disabled state of the main action buttons and forms.
         * Prevents users from attempting database writes before authentication is complete.
         * @param {boolean} enable - True to enable, false to disable.
         */
        const toggleInteractionState = (enable) => {
            const buttons = [
                document.getElementById('add-source-btn'),
                document.getElementById('add-user-btn'),
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.disabled = !enable;
                    btn.classList.toggle('btn-disabled', !enable);
                }
            });

            // Note: Individual save buttons inside modals are not directly disabled here, 
            // but the modal submit handler will check auth readiness before proceeding.
        };


        // --- Firebase Initialization and Authentication ---

        const initializeFirebase = async () => {
            showLoading(true);
            toggleInteractionState(false); // Disable actions initially
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `User ID: ${userId}`;
                    } else {
                        // This should only run if initialAuthToken is missing (development setup)
                        const anonUser = await signInAnonymously(auth);
                        userId = anonUser.user.uid;
                        document.getElementById('auth-status').textContent = `User ID: ${userId} (Anonymous)`;
                    }
                    isAuthReady = true;
                    showLoading(false);
                    toggleInteractionState(true); // Enable actions once auth is ready
                    // Start listening to collections only after auth is ready
                    startDataListeners();
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                document.getElementById('auth-status').textContent = `Authentication Error. See console for details.`;
                showLoading(false);
                toggleInteractionState(false);
            }
        };

        // --- Data Retrieval and Real-time Listeners ---

        let sources = []; // Global store for sources
        let users = []; // Global store for users

        const getSourceCollectionRef = () => {
            // Path: artifacts/{appId}/users/{userId}/m3u_sources
            if (!isAuthReady || !userId || !db) {
                console.error("Database or User ID not ready for getSourceCollectionRef");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'm3u_sources');
        };

        const getUserCollectionRef = () => {
             // Path: artifacts/{appId}/users/{userId}/iptv_users
            if (!isAuthReady || !userId || !db) {
                console.error("Database or User ID not ready for getUserCollectionRef");
                return null;
            }
            return collection(db, 'artifacts', appId, 'users', userId, 'iptv_users');
        };

        const startDataListeners = () => {
            if (!isAuthReady || !userId) return;

            // 1. Listen for M3U Sources (Private Data)
            const sourceRef = getSourceCollectionRef();
            if (sourceRef) {
                onSnapshot(sourceRef, (snapshot) => {
                    sources = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), userCount: 0 }));
                    renderSources();
                    updateUserSourceDropdown();
                    updateDashboardStats();
                }, (error) => {
                    console.error("Error listening to sources:", error);
                    // If it fails here, the security rule for READ is also failing.
                    showMessage('Data Error', 'Failed to load M3U Sources due to a permission issue. Check console for path errors.');
                });
            }

            // 2. Listen for Users (Private Data)
            const userRef = getUserCollectionRef();
            if (userRef) {
                onSnapshot(userRef, (snapshot) => {
                    users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderUsers();
                    updateSourceUserCounts();
                    updateDashboardStats();
                }, (error) => {
                    console.error("Error listening to users:", error);
                    showMessage('Data Error', 'Failed to load IPTV Users due to a permission issue. Check console for path errors.');
                });
            }
        };

        // --- Rendering Functions ---

        const updateDashboardStats = () => {
            const now = new Date().getTime();
            const activeUsers = users.filter(user => new Date(user.expiryDate).getTime() > now).length;

            document.getElementById('stat-total-users').textContent = users.length;
            document.getElementById('stat-active-users').textContent = activeUsers;
            document.getElementById('stat-total-sources').textContent = sources.length;
        };

        const updateSourceUserCounts = () => {
            const userCounts = {};
            users.forEach(user => {
                userCounts[user.sourceId] = (userCounts[user.sourceId] || 0) + 1;
            });
            sources.forEach(source => {
                source.userCount = userCounts[source.id] || 0;
            });
            renderSources();
        };

        const renderSources = () => {
            const listElement = document.getElementById('sources-list');
            listElement.innerHTML = '';
            
            sources.forEach(source => {
                const row = listElement.insertRow();
                row.className = 'hover:bg-gray-50 transition-colors duration-100';
                
                // Name
                row.insertCell().textContent = source.name;
                
                // URL (Truncated for display)
                const urlCell = row.insertCell();
                urlCell.className = 'text-sm text-gray-500 max-w-xs truncate';
                urlCell.textContent = source.url.length > 50 ? source.url.substring(0, 47) + '...' : source.url;

                // User Count
                row.insertCell().textContent = source.userCount;
                
                // Actions
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'text-indigo-600 hover:text-indigo-900 mr-3';
                editButton.onclick = () => openSourceModal(source.id);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'text-red-600 hover:text-red-900';
                deleteButton.onclick = () => deleteSource(source.id, source.name);

                actionsCell.appendChild(editButton);
                actionsCell.appendChild(deleteButton);
            });
        };

        const renderUsers = () => {
            const listElement = document.getElementById('users-list');
            listElement.innerHTML = '';

            const today = new Date();
            
            users.forEach(user => {
                const row = listElement.insertRow();
                const expiryDate = new Date(user.expiryDate);
                const isExpired = expiryDate < today;

                row.className = isExpired ? 'bg-red-50 hover:bg-red-100 transition-colors duration-100 text-red-700' : 'hover:bg-gray-50 transition-colors duration-100';
                
                const source = sources.find(s => s.id === user.sourceId);
                const sourceName = source ? source.name : 'Unknown Source';
                const baseUrl = source ? source.url.split('?')[0] : ''; // Get base URL without params

                // Username
                row.insertCell().textContent = user.username;
                
                // Password
                row.insertCell().textContent = user.password;
                
                // Source
                row.insertCell().textContent = sourceName;
                
                // Expires
                const expiryCell = row.insertCell();
                expiryCell.textContent = user.expiryDate;
                expiryCell.className = isExpired ? 'font-bold' : '';

                // M3U Link
                const linkCell = row.insertCell();
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copy Link';
                copyBtn.className = 'text-blue-600 hover:text-blue-800 text-sm font-medium';
                copyBtn.onclick = () => generateAndShowM3ULink(baseUrl, user.username, user.password);
                linkCell.appendChild(copyBtn);
                
                // Actions
                const actionsCell = row.insertCell();
                actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.className = 'text-indigo-600 hover:text-indigo-900 mr-3';
                editButton.onclick = () => openUserModal(user.id);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'text-red-600 hover:text-red-900';
                deleteButton.onclick = () => deleteUser(user.id, user.username);

                actionsCell.appendChild(editButton);
                actionsCell.appendChild(deleteButton);
            });
        };

        const updateUserSourceDropdown = () => {
            const selectElement = document.getElementById('user-source');
            selectElement.innerHTML = '<option value="" disabled selected>Select a source</option>';
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = source.id;
                option.textContent = source.name;
                selectElement.appendChild(option);
            });
        };

        // --- CRUD Logic for M3U Sources ---

        window.openSourceModal = (sourceId = null) => {
            if (!isAuthReady) {
                showMessage('Loading...', 'Please wait for the dashboard to finish initializing before adding data.', null);
                return;
            }

            const modal = document.getElementById('source-modal');
            const form = document.getElementById('source-form');
            form.reset();
            document.getElementById('source-id').value = '';

            if (sourceId) {
                const source = sources.find(s => s.id === sourceId);
                if (source) {
                    document.getElementById('source-id').value = source.id;
                    document.getElementById('source-name').value = source.name;
                    document.getElementById('source-url').value = source.url;
                }
            }
            modal.classList.remove('hidden');
        };

        window.closeSourceModal = () => {
            document.getElementById('source-modal').classList.add('hidden');
        };

        document.getElementById('source-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady || !userId) {
                showMessage('Authentication Error', 'Cannot save data until authentication is complete.', null);
                return;
            }
            
            closeSourceModal();
            showLoading(true);

            const id = document.getElementById('source-id').value;
            const name = document.getElementById('source-name').value;
            const url = document.getElementById('source-url').value;

            const sourceData = { name, url, ownerId: userId };
            const sourceRef = getSourceCollectionRef();
            
            if (!sourceRef) {
                console.error("Source collection reference is null. Auth issue likely.");
                showLoading(false);
                showMessage('Error', `Failed to save source. Database path is invalid.`);
                return;
            }

            // --- DEBUG LOGGING ADDED HERE ---
            const failedPath = `artifacts/${appId}/users/${userId}/m3u_sources`;
            console.log(`[Firestore DEBUG] Attempting to save source for UID: ${userId}`);
            console.log(`[Firestore DEBUG] Target Collection Path: ${failedPath}`);
            console.log(`[Firestore DEBUG] Source Data:`, sourceData);
            // --- END DEBUG LOGGING ---

            try {
                if (id) {
                    await setDoc(doc(sourceRef, id), sourceData);
                    showMessage('Source Updated', `The source "${name}" has been successfully updated.`);
                } else {
                    await addDoc(sourceRef, sourceData);
                    showMessage('Source Added', `The new source "${name}" has been successfully saved.`);
                }
            } catch (error) {
                console.error("Error saving source:", error);
                
                // IMPROVED MODAL MESSAGE
                showMessage(
                    'Database Error (Permission Denied)', 
                    `Failed to save source. The database rejected the write operation. 
                     Please check the console for "Permission Denied" errors and verify that this User ID (${userId}) has write access to the following path: ${failedPath}`, 
                     null
                );
            } finally {
                showLoading(false);
            }
        });

        const deleteSource = async (id, name) => {
             // In a real app, this would use a confirm modal.
             if (!confirm(`Are you sure you want to delete the source: "${name}"? This will affect ${users.filter(u => u.sourceId === id).length} users.`)) return;
             if (!isAuthReady) return;

            showLoading(true);
            try {
                const sourceRef = getSourceCollectionRef();
                if (!sourceRef) throw new Error("Source collection reference not ready.");

                // 1. Delete the source document
                await deleteDoc(doc(sourceRef, id));

                // 2. Remove users associated with this source 
                const batchUpdates = [];
                const usersToDelete = users.filter(u => u.sourceId === id);
                const userRef = getUserCollectionRef();
                
                if (userRef) {
                    for (const user of usersToDelete) {
                        batchUpdates.push(deleteDoc(doc(userRef, user.id)));
                    }
                }
                
                await Promise.all(batchUpdates);

                showMessage('Source Deleted', `The source "${name}" and all associated users have been removed.`);

            } catch (error) {
                console.error("Error deleting source:", error);
                showMessage('Error', 'Failed to delete source or associated users.');
            } finally {
                showLoading(false);
            }
        };

        // --- CRUD Logic for Users ---

        window.openUserModal = (userIdToEdit = null) => {
            if (!isAuthReady) {
                showMessage('Loading...', 'Please wait for the dashboard to finish initializing before adding data.', null);
                return;
            }
            if (sources.length === 0) {
                showMessage('Cannot Add User', 'You must add at least one M3U Source before creating a user.', null);
                return;
            }

            const modal = document.getElementById('user-modal');
            const form = document.getElementById('user-form');
            form.reset();
            document.getElementById('user-id').value = '';

            if (userIdToEdit) {
                const user = users.find(u => u.id === userIdToEdit);
                if (user) {
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-password').value = user.password;
                    document.getElementById('user-source').value = user.sourceId;
                    document.getElementById('user-expiry').value = user.expiryDate;
                }
            } else {
                // Set default expiry to 30 days from now
                const defaultExpiry = new Date();
                defaultExpiry.setDate(defaultExpiry.getDate() + 30);
                document.getElementById('user-expiry').value = defaultExpiry.toISOString().substring(0, 10);
            }
            modal.classList.remove('hidden');
        };

        window.closeUserModal = () => {
            document.getElementById('user-modal').classList.add('hidden');
        };

        document.getElementById('user-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!isAuthReady || !userId) {
                showMessage('Authentication Error', 'Cannot save data until authentication is complete.', null);
                return;
            }

            closeUserModal();
            showLoading(true);

            const id = document.getElementById('user-id').value;
            const username = document.getElementById('user-username').value;
            const password = document.getElementById('user-password').value;
            const sourceId = document.getElementById('user-source').value;
            const expiryDate = document.getElementById('user-expiry').value;

            const userData = { username, password, sourceId, expiryDate, createdAt: new Date().toISOString() };
            const userRef = getUserCollectionRef();

            if (!userRef) {
                console.error("User collection reference is null. Auth issue likely.");
                showLoading(false);
                showMessage('Error', `Failed to save user. Database path is invalid.`);
                return;
            }
            
            // --- DEBUG LOGGING ADDED HERE ---
            const failedPath = `artifacts/${appId}/users/${userId}/iptv_users`;
            console.log(`[Firestore DEBUG] Attempting to save user for UID: ${userId}`);
            console.log(`[Firestore DEBUG] Target Collection Path: ${failedPath}`);
            console.log(`[Firestore DEBUG] User Data:`, userData);
            // --- END DEBUG LOGGING ---

            try {
                if (id) {
                    await setDoc(doc(userRef, id), userData);
                    showMessage('User Updated', `The user "${username}" has been successfully updated.`);
                } else {
                    const newDocRef = await addDoc(userRef, userData);
                    const source = sources.find(s => s.id === sourceId);
                    const baseUrl = source ? source.url.split('?')[0] : '';
                    
                    generateAndShowM3ULink(baseUrl, username, password, true); // Show link immediately for new user
                }
            } catch (error) {
                console.error("Error saving user:", error);
                
                showMessage(
                    'Database Error (Permission Denied)', 
                    `Failed to save user. The database rejected the write operation. 
                     Please check the console for "Permission Denied" errors and verify that this User ID (${userId}) has write access to the following path: ${failedPath}`, 
                     null
                );
            } finally {
                showLoading(false);
            }
        });

        const deleteUser = async (id, username) => {
            // In a real app, this would use a confirm modal.
            if (!confirm(`Are you sure you want to delete the user: "${username}"?`)) return;
            if (!isAuthReady) return;

            showLoading(true);
            try {
                const userRef = getUserCollectionRef();
                if (!userRef) throw new Error("User collection reference not ready.");

                await deleteDoc(doc(userRef, id));
                showMessage('User Deleted', `The user "${username}" has been removed.`);
            } catch (error) {
                console.error("Error deleting user:", error);
                showMessage('Error', 'Failed to delete user.');
            } finally {
                showLoading(false);
            }
        };

        // --- M3U Link Generation ---

        /**
         * Generates the personalized M3U link and shows it in the message modal.
         */
        const generateAndShowM3ULink = (baseUrl, username, password, isNewUser = false) => {
            if (!baseUrl || baseUrl === '') {
                showMessage('Error', 'The selected source has an invalid or missing URL.', null);
                return;
            }

            // Simple logic to replace placeholders in the base URL
            let finalUrl = baseUrl;
            
            // Check if the URL already contains 'username=' or 'password=', if so, use simple replacement
            if (finalUrl.includes('{{username}}') || finalUrl.includes('{{password}}')) {
                finalUrl = finalUrl.replace('{{username}}', username).replace('{{password}}', password);
            } else {
                // If no placeholders, assume standard format and append
                // This is a simplified example. Real servers vary greatly.
                const connector = finalUrl.includes('?') ? '&' : '?';
                finalUrl = `${finalUrl}${connector}username=${username}&password=${password}`;
            }

            const title = isNewUser ? 'User Created!' : 'Link Generated!';
            const content = isNewUser ? 
                `The user "${username}" was created successfully. Share the personalized M3U link below with them.` :
                `The personalized M3U link for "${username}" has been generated.`;
            
            showMessage(title, content, finalUrl);
        };


        // --- Tab Management ---
        window.showTab = (tabName) => {
            ['dashboard', 'users', 'sources'].forEach(name => {
                document.getElementById(`${name}-tab`).classList.add('hidden');
                document.querySelector(`.tab-button[data-tab="${name}"]`).classList.remove('bg-blue-100', 'text-blue-700', 'font-semibold');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('bg-blue-100', 'text-blue-700', 'font-semibold');
        };

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            showTab('dashboard'); // Default view
        });

    </script>
</body>
</html>
